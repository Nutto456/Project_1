<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Driver Monitor</title>
  <style>
    body { font-family: sans-serif; display: grid; place-items: center; min-height: 100vh; background: #222; margin: 0; }
    video { width: 100%; max-width: 800px; background: #000; border: 2px solid #555; }
    h1 { color: white; }
  </style>
</head>
<body>

  <h1>Driver Monitor Feed</h1>
  <video id="driverVideo" autoplay playsinline muted></video>

  <script>
    // 1. ตั้งค่า Server (STUN ฟรี, TURN ฟรีสำหรับเทส)
    const WSS_URL = 'wss://your-render-url.onrender.com'; // ❗️❗️ เปลี่ยนเป็น URL ของคุณ
    
    const iceServers = [
      { urls: 'stun:stun.l.google.com:19302' },
      { urls: 'stun:stun1.l.google.com:19302' },
      { // TURN Server ฟรี (อาจช้า/ล่มได้)
        urls: 'turn:openrelay.metered.ca:80',
        username: 'openrelayproject',
        credential: 'openrelayproject'
      }
    ];

    const videoEl = document.getElementById('driverVideo');
    let pc; // PeerConnection
    let ws; // WebSocket

    function createPeerConnection() {
      pc = new RTCPeerConnection({ iceServers: iceServers });

      // เมื่อหา "เส้นทาง" (Candidate) เจอ ให้ส่งไปบอกอีกฝั่ง
      pc.onicecandidate = (event) => {
        if (event.candidate) {
          ws.send(JSON.stringify({ type: 'candidate', payload: event.candidate }));
        }
      };

      // เมื่อ "สตรีม" มาถึง!
      pc.ontrack = (event) => {
        console.log('Got remote track!');
        videoEl.srcObject = event.streams[0];
      };
    }

    function connectWebSocket() {
      ws = new WebSocket(WSS_URL);

      ws.onopen = () => {
        console.log('Connected to Signaling Server as Monitor');
        createPeerConnection(); // สร้าง PeerConnection เมื่อต่อ WS สำเร็จ
      };

      // เมื่อได้รับข้อความจาก Signaling Server
      ws.onmessage = async (message) => {
        const data = JSON.parse(message.data);
        // console.log('Received data:', data.type);

        switch (data.type) {
          case 'offer': // 1. ได้รับ "คำเชิญ" (Offer) จากคนขับ
            await pc.setRemoteDescription(new RTCSessionDescription(data.payload));
            
            // 2. สร้าง "คำตอบ" (Answer)
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            
            // 3. ส่ง "คำตอบ" กลับไป
            ws.send(JSON.stringify({ type: 'answer', payload: answer }));
            break;
            
          case 'candidate': // ได้รับ "เส้นทาง" (Candidate) จากคนขับ
            if (data.payload) {
              await pc.addIceCandidate(new RTCIceCandidate(data.payload));
            }
            break;
            
          case 'info':
            console.log('Server Info:', data.message);
            break;
        }
      };

      ws.onclose = () => {
        console.log('Disconnected from server. Retrying...');
        pc.close();
        setTimeout(connectWebSocket, 3000); // พยายามต่อใหม่ใน 3 วิ
      };
      
      ws.onerror = (err) => {
        console.error('WebSocket Error:', err);
      };
    }

    // เริ่มการเชื่อมต่อ
    connectWebSocket();
  </script>
</body>
</html>