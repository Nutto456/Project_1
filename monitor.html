<!DOCTYPE html>
<html lang="th" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Driver Monitor (Audio)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    /* ซ่อน audio element */
    #driverAudio {
        display: none;
    }
    /* จัดกลุ่มปุ่มควบคุมเสียง */
    #audioControls {
        display: flex;
        gap: 0.5rem; /* ระยะห่างระหว่างปุ่ม */
        margin-top: 1rem; /* ระยะห่างจาก Status Indicator */
    }
    /* สไตล์ปุ่มควบคุมเสียง */
    .control-button {
      background-color: rgba(71, 85, 105, 0.6); /* bg-slate-700 opacity 60% */
      border: 1px solid rgba(100, 116, 139, 0.5); /* border-slate-600 opacity 50% */
      backdrop-filter: blur(5px);
      padding: 0.5rem; /* p-2 */
      border-radius: 9999px; /* rounded-full */
      color: white;
      opacity: 0.8;
      transition: opacity 0.15s ease-in-out, background-color 0.15s ease-in-out;
    }
    .control-button:hover {
      opacity: 1;
      background-color: rgba(51, 65, 85, 0.8); /* bg-slate-800 opacity 80% */
    }
    .control-button svg {
      width: 1.25rem; /* w-5 */
      height: 1.25rem; /* h-5 */
    }
    /* ทำให้ปุ่ม active ดูต่างออกไปเล็กน้อย (เช่น ตอน Mute) */
     .control-button.active {
       background-color: rgba(220, 38, 38, 0.7); /* bg-red-600 opacity 70% */
       border-color: rgba(185, 28, 28, 0.6); /* border-red-700 opacity 60% */
     }

  </style>
</head>
<body class="bg-slate-900 text-white">

  <h1 class="text-2xl font-bold mb-4">Driver Monitor (Audio Feed)</h1>

  <audio id="driverAudio" autoplay playsinline></audio>

  <div id="statusIndicator" class="mt-4 text-sm text-slate-400 flex items-center gap-2">
    <span id="statusDot" class="w-3 h-3 rounded-full bg-red-500 inline-block animate-pulse"></span>
    <span id="statusText">Disconnected</span>
  </div>

  <div id="audioControls" class="hidden"> <button id="muteMicButton" class="control-button" title="Mute Driver Mic">
          <svg id="iconMicOn" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8.25 4.5a3.75 3.75 0 117.5 0v8.25a3.75 3.75 0 11-7.5 0V4.5z" />
              <path d="M6 10.5a.75.75 0 01.75.75v1.5a5.25 5.25 0 1010.5 0v-1.5a.75.75 0 011.5 0v1.5a6.751 6.751 0 01-6 6.709v2.291h3a.75.75 0 010 1.5h-7.5a.75.75 0 010-1.5h3v-2.291a6.751 6.751 0 01-6-6.709v-1.5A.75.75 0 016 10.5z" />
          </svg>
          <svg id="iconMicOff" class="hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M13.875 3.633a3.743 3.743 0 00-3.75 0V11.84c.488.118.96.307 1.375.558V4.5a2.25 2.25 0 014.5 0v7.898a6.839 6.839 0 01-6.75 6.709v2.291h3a.75.75 0 010 1.5h-7.5a.75.75 0 010-1.5h3v-2.291a6.839 6.839 0 01-6.75-6.709V12.75a.75.75 0 011.5 0v-.009A5.23 5.23 0 008.25 12.16V4.5a2.25 2.25 0 01-.06-.517 3.743 3.743 0 005.686-.35z" />
              <path d="M22.01 4.979L4.978 22.011a.75.75 0 01-1.06-1.06L20.95 3.919a.75.75 0 011.06 1.06z" />
          </svg>
      </button>
      <button id="muteSpeakerButton" class="control-button" title="Mute Your Speaker">
          <svg id="iconSpeakerOn" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.348 2.595.341 1.24 1.518 1.905 2.66 1.905H6.44l4.5 4.5c.944.945 2.56.276 2.56-1.06V4.06zM18.584 5.106a.75.75 0 011.06 0c3.808 3.807 3.808 9.98 0 13.788a.75.75 0 01-1.06-1.06 8.25 8.25 0 000-11.668.75.75 0 010-1.06z" />
              <path d="M15.932 7.757a.75.75 0 011.061 0 6 6 0 010 8.486.75.75 0 01-1.06-1.061 4.5 4.5 0 000-6.364.75.75 0 010-1.06z" />
          </svg>
          <svg id="iconSpeakerOff" class="hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.348 2.595.341 1.24 1.518 1.905 2.66 1.905H6.44l4.5 4.5c.944.945 2.56.276 2.56-1.06V4.06z" />
              <path d="M17.28 9.72a.75.75 0 00-1.06 1.06 4.5 4.5 0 010 6.364.75.75 0 001.06 1.06 6 6 0 000-8.486.75.75 0 00-1.06 0z" />
              <path d="M19.94 7.05a.75.75 0 00-1.06 1.06 8.25 8.25 0 010 11.668.75.75 0 101.06 1.06c3.808-3.807 3.808-9.98 0-13.788zM22.01 4.979L4.978 22.011a.75.75 0 01-1.06-1.06L20.95 3.919a.75.75 0 011.06 1.06z" />
          </svg>
      </button>
  </div>
  <div id="driverInfo" class="mt-4 p-4 rounded-lg bg-slate-800 border border-slate-700 w-full max-w-md text-sm text-slate-300 hidden">
      <div class="flex justify-between mb-2 pb-2 border-b border-slate-700">
          <span class="flex flex-col items-center">
              <span class="text-xs text-slate-400">SCORE</span>
              <strong id="infoScore" class="text-2xl text-white font-semibold">--</strong>
          </span>
          <span class="flex flex-col items-center">
              <span class="text-xs text-slate-400">SPEED</span>
              <strong id="infoSpeed" class="text-2xl text-white font-semibold">--</strong>
              <span class="text-xs text-slate-400 -mt-1">KPH</span>
          </span>
      </div>
      <div class="mt-1 text-center">
          <span class="text-xs text-slate-400 block mb-1">DRIVER STATUS</span>
          <span id="infoAlerts" class="text-slate-500 font-semibold px-2 py-1 rounded text-base">N/A</span>
      </div>
  </div>


  <script>
    // URL Server (ถูกต้องแล้ว)
    const WSS_URL = 'wss://project-1-6xbs.onrender.com';

    // ICE Servers (ถูกต้องแล้ว)
    const iceServers = [
      { urls: 'stun:stun.l.google.com:19302' },
      { urls: 'stun:stun1.l.google.com:19302' },
      { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' },
      { urls: 'turn:openrelay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' }
    ];

    // Element ต่างๆ
    const audioEl = document.getElementById('driverAudio');
    const statusIndicator = document.getElementById('statusIndicator');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const driverInfoEl = document.getElementById('driverInfo');
    const infoScoreEl = document.getElementById('infoScore');
    const infoSpeedEl = document.getElementById('infoSpeed');
    const infoAlertsEl = document.getElementById('infoAlerts');

    // (เพิ่ม) Element ปุ่มควบคุมเสียง
    const audioControlsEl = document.getElementById('audioControls');
    const muteMicButton = document.getElementById('muteMicButton');
    const iconMicOn = document.getElementById('iconMicOn');
    const iconMicOff = document.getElementById('iconMicOff');
    const muteSpeakerButton = document.getElementById('muteSpeakerButton');
    const iconSpeakerOn = document.getElementById('iconSpeakerOn');
    const iconSpeakerOff = document.getElementById('iconSpeakerOff');


    let pc; // PeerConnection
    let ws; // WebSocket
    let isMicMuted = false; // สถานะ Mute เสียงจาก Driver
    let isSpeakerMuted = false; // สถานะ Mute ลำโพงตัวเอง

    // --- ฟังก์ชันอัปเดตสถานะ ---
    function updateStatus(connected, message = '') {
      if (connected) {
        statusDot.classList.remove('bg-red-500', 'animate-pulse');
        statusDot.classList.add('bg-green-500');
        statusText.textContent = message || 'Connected';
        audioControlsEl.classList.remove('hidden'); // แสดงปุ่มควบคุมเสียงเมื่อต่อติด
      } else {
        statusDot.classList.remove('bg-green-500');
        statusDot.classList.add('bg-red-500', 'animate-pulse');
        statusText.textContent = message || 'Disconnected';
        if (audioEl.srcObject) {
            audioEl.srcObject.getTracks().forEach(track => track.stop());
            audioEl.srcObject = null;
        }
        driverInfoEl.classList.add('hidden'); // ซ่อนข้อมูลคนขับเมื่อหลุด
        audioControlsEl.classList.add('hidden'); // ซ่อนปุ่มควบคุมเสียงเมื่อหลุด
      }
    }

    // --- ฟังก์ชัน Mute/Unmute เสียงจาก Driver (ควบคุม Audio Track ที่ได้รับมา) ---
    function toggleMicMute() {
      isMicMuted = !isMicMuted;
      // หา Audio Track ที่ได้รับมา แล้วสั่ง enabled = false/true
      if (pc && pc.getReceivers) {
          pc.getReceivers().forEach(receiver => {
              if (receiver.track && receiver.track.kind === 'audio') {
                  receiver.track.enabled = !isMicMuted;
                  console.log(`Driver audio track enabled: ${!isMicMuted}`);
              }
          });
      }
      // อัปเดต UI ปุ่ม
      iconMicOn.classList.toggle('hidden', isMicMuted);
      iconMicOff.classList.toggle('hidden', !isMicMuted);
      muteMicButton.classList.toggle('active', isMicMuted); // เพิ่ม/ลด class 'active'
      muteMicButton.setAttribute('title', isMicMuted ? 'Unmute Driver Mic' : 'Mute Driver Mic');
    }

    // --- ฟังก์ชัน Mute/Unmute ลำโพงตัวเอง (ควบคุม audio element) ---
    function toggleSpeakerMute() {
        isSpeakerMuted = !isSpeakerMuted;
        audioEl.muted = isSpeakerMuted; // สั่ง Mute/Unmute ที่ตัว audio element
        // อัปเดต UI ปุ่ม
        iconSpeakerOn.classList.toggle('hidden', isSpeakerMuted);
        iconSpeakerOff.classList.toggle('hidden', !isSpeakerMuted);
        muteSpeakerButton.classList.toggle('active', isSpeakerMuted);
        muteSpeakerButton.setAttribute('title', isSpeakerMuted ? 'Unmute Your Speaker' : 'Mute Your Speaker');
    }

    // ตั้งค่าเริ่มต้น & เพิ่ม Event Listener ให้ปุ่ม
    audioEl.muted = isSpeakerMuted; // ลำโพงตัวเองไม่ Mute ตอนเริ่ม
    iconSpeakerOn.classList.toggle('hidden', isSpeakerMuted);
    iconSpeakerOff.classList.toggle('hidden', !isSpeakerMuted);
    muteSpeakerButton.setAttribute('title', isSpeakerMuted ? 'Unmute Your Speaker' : 'Mute Your Speaker');
    muteSpeakerButton.addEventListener('click', toggleSpeakerMute);

    // เสียงจาก Driver เริ่มต้นไม่ Mute
    iconMicOn.classList.toggle('hidden', isMicMuted);
    iconMicOff.classList.toggle('hidden', !isMicMuted);
    muteMicButton.setAttribute('title', isMicMuted ? 'Unmute Driver Mic' : 'Mute Driver Mic');
    muteMicButton.addEventListener('click', toggleMicMute);


    // --- WebRTC Logic (แก้ไข ontrack) ---
    function createPeerConnection() {
      pc = new RTCPeerConnection({ iceServers: iceServers });

      pc.onicecandidate = (event) => {
        if (event.candidate && ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'candidate', payload: event.candidate }));
        }
      };

      pc.ontrack = (event) => {
        console.log('Got remote track (kind:', event.track.kind + ')!');
        if (event.track.kind === 'audio' && event.streams && event.streams[0]) {
             audioEl.srcObject = event.streams[0];
             // ตั้งค่า enabled ตามสถานะ isMicMuted ปัจจุบัน
             event.track.enabled = !isMicMuted;
             audioEl.play().catch(e => console.error("Audio play failed:", e));
             driverInfoEl.classList.remove('hidden'); // แสดงข้อมูลเมื่อ Track มา
        }
      };

      pc.onconnectionstatechange = (event) => {
          const state = pc.connectionState;
          console.log('PeerConnection State:', state);
          if (state === 'connected') {
              updateStatus(true, 'Stream Connected');
              driverInfoEl.classList.remove('hidden');
              audioControlsEl.classList.remove('hidden'); // แสดงปุ่มเมื่อ Stream ต่อติด
          } else if (state === 'failed' || state === 'disconnected' || state === 'closed') {
              updateStatus(false, 'Stream Disconnected');
              if(pc) pc.close();
              pc = null;
              // รีเซ็ตข้อมูลคนขับ
              infoScoreEl.textContent = '--';
              infoSpeedEl.textContent = '--';
              infoAlertsEl.textContent = 'N/A';
              infoAlertsEl.className = 'text-slate-500 font-semibold px-2 py-1 rounded text-base';
              driverInfoEl.classList.add('hidden');
              audioControlsEl.classList.add('hidden'); // ซ่อนปุ่มเมื่อ Stream หลุด
          } else {
              updateStatus(true, `Stream ${state}...`);
              driverInfoEl.classList.add('hidden');
              audioControlsEl.classList.add('hidden'); // ซ่อนปุ่มระหว่างเชื่อมต่อ
          }
      };
    }

    function connectWebSocket() {
      updateStatus(false, 'Connecting to server...');
      driverInfoEl.classList.add('hidden');
      audioControlsEl.classList.add('hidden'); // ซ่อนปุ่มตอนเริ่มต่อ
      ws = new WebSocket(WSS_URL);

      ws.onopen = () => {
        console.log('Connected to Signaling Server as Monitor');
        ws.send(JSON.stringify({ type: 'identify', role: 'monitor' }));
        updateStatus(true, 'Server Connected');
        createPeerConnection();
      };

      ws.onmessage = async (message) => {
        const data = JSON.parse(message.data);
        if (data.type === 'info') {
           console.log('Server Info:', data.message);
        } else {
           switch (data.type) {
              case 'offer':
                if (!pc) createPeerConnection();
                await pc.setRemoteDescription(new RTCSessionDescription(data.payload));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                ws.send(JSON.stringify({ type: 'answer', payload: answer }));
                break;
              case 'candidate':
                if (pc && data.payload) {
                  try { await pc.addIceCandidate(new RTCIceCandidate(data.payload)); }
                  catch (e) { console.error('Error adding ICE candidate', e); }
                }
                break;

              case 'statusUpdate':
                // ... (โค้ด statusUpdate เหมือนเดิม) ...
                const payload = data.payload;
                infoScoreEl.textContent = payload.score ?? '--';
                infoSpeedEl.textContent = payload.speed ?? '--';
                const alerts = payload.alerts;
                let alertText = 'NORMAL';
                const activeAlerts = [];
                if (alerts.takeBreak) activeAlerts.push('พักผ่อนด่วน!');
                if (alerts.eyeAlert) activeAlerts.push('หลับตา');
                if (alerts.handsAlert) activeAlerts.push('ปล่อยมือสองข้าง');
                if (alerts.wheelAlert) activeAlerts.push('ละมือจากพวงมาลัย');
                if (alerts.phoneAlert) activeAlerts.push('ใช้โทรศัพท์');
                if (alerts.pitchText === 'ก้มหน้า') activeAlerts.push('ก้มหน้า');
                if (alerts.pitchText === 'เงยหน้า') activeAlerts.push('เงยหน้า');
                if (alerts.yawnAlert) activeAlerts.push('หาว');
                if (alerts.faceLost) activeAlerts.push('ไม่พบใบหน้า');
                if (alerts.yawText === 'หันซ้าย') activeAlerts.push('หันซ้าย');
                if (alerts.yawText === 'หันขวา') activeAlerts.push('หันขวา');

                if (activeAlerts.length > 0) {
                    alertText = activeAlerts.join(' / ');
                    infoAlertsEl.textContent = alertText;
                    infoAlertsEl.className = 'text-red-400 font-semibold px-2 py-1 rounded bg-red-900/50 text-base animate-pulse';
                } else {
                    infoAlertsEl.textContent = alertText;
                    infoAlertsEl.className = 'text-green-400 font-semibold px-2 py-1 rounded bg-green-900/50 text-base';
                }
                break;
            } // จบ switch
        } // จบ else
      }; // จบ onmessage

      ws.onclose = () => {
        console.log('Disconnected from server. Retrying...');
        updateStatus(false, 'Server Disconnected. Retrying...'); // Server หลุด
        if(pc) {
          pc.close();
          pc = null;
        }
        // รีเซ็ตข้อมูลคนขับ
        infoScoreEl.textContent = '--';
        infoSpeedEl.textContent = '--';
        infoAlertsEl.textContent = 'N/A';
        infoAlertsEl.className = 'text-slate-500 font-semibold px-2 py-1 rounded text-base';
        driverInfoEl.classList.add('hidden');
        audioControlsEl.classList.add('hidden'); // ซ่อนปุ่ม

        setTimeout(connectWebSocket, 3000);
      };

      ws.onerror = (err) => {
        console.error('WebSocket Error:', err);
        updateStatus(false, 'Server Connection Error'); // เกิด Error
        driverInfoEl.classList.add('hidden');
        audioControlsEl.classList.add('hidden'); // ซ่อนปุ่ม
      };
    }

    // เริ่มการเชื่อมต่อ
    connectWebSocket();
  </script>
</body>
</html>