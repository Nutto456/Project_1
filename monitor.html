<!DOCTYPE html>
<html lang="th" class="dark"> <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Driver Monitor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ... (CSS ทั้งหมดเหมือนเดิม) ... */
    body {
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    #videoContainer {
      position: relative;
      width: 100%;
      max-width: 800px;
      overflow: hidden;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1);
      display: block;
    }
    #muteButton {
      position: absolute;
      bottom: 1rem;
      right: 1rem;
      z-index: 10;
      background-color: rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(5px);
    }
    #muteButton:hover {
      background-color: rgba(0, 0, 0, 0.8);
    }
    #muteButton svg {
      width: 1.25rem; /* 20px */
      height: 1.25rem; /* 20px */
    }
  </style>
</head>
<body class="bg-slate-900 text-white"> <h1 class="text-2xl font-bold mb-4">Driver Monitor Feed</h1>

  <div id="videoContainer" class="rounded-lg shadow-lg bg-black border border-slate-700">
    <video id="driverVideo" autoplay playsinline></video>

    <button id="muteButton" class="p-2 rounded-full text-white opacity-80 hover:opacity-100 transition-opacity" title="Mute/Unmute">
      <svg id="iconSpeaker" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.348 2.595.341 1.24 1.518 1.905 2.66 1.905H6.44l4.5 4.5c.944.945 2.56.276 2.56-1.06V4.06zM18.584 5.106a.75.75 0 011.06 0c3.808 3.807 3.808 9.98 0 13.788a.75.75 0 01-1.06-1.06 8.25 8.25 0 000-11.668.75.75 0 010-1.06z" />
        <path d="M15.932 7.757a.75.75 0 011.061 0 6 6 0 010 8.486.75.75 0 01-1.06-1.061 4.5 4.5 0 000-6.364.75.75 0 010-1.06z" />
      </svg>
      <svg id="iconMuted" class="hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.348 2.595.341 1.24 1.518 1.905 2.66 1.905H6.44l4.5 4.5c.944.945 2.56.276 2.56-1.06V4.06z" />
        <path d="M17.28 9.72a.75.75 0 00-1.06 1.06 4.5 4.5 0 010 6.364.75.75 0 001.06 1.06 6 6 0 000-8.486.75.75 0 00-1.06 0z" />
        <path d="M19.94 7.05a.75.75 0 00-1.06 1.06 8.25 8.25 0 010 11.668.75.75 0 101.06 1.06c3.808-3.807 3.808-9.98 0-13.788zM22.01 4.979L4.978 22.011a.75.75 0 01-1.06-1.06L20.95 3.919a.75.75 0 011.06 1.06z" />
      </svg>
    </button>
  </div>

  <div id="statusIndicator" class="mt-4 text-sm text-slate-400 flex items-center gap-2">
    <span id="statusDot" class="w-3 h-3 rounded-full bg-red-500 inline-block animate-pulse"></span> <span id="statusText">Disconnected</span> </div>

  <div id="driverInfo" class="mt-4 p-4 rounded-lg bg-slate-800 border border-slate-700 w-full max-w-md text-sm text-slate-300 hidden"> <div class="flex justify-between mb-2 pb-2 border-b border-slate-700">
          <span class="flex flex-col items-center">
              <span class="text-xs text-slate-400">SCORE</span>
              <strong id="infoScore" class="text-2xl text-white font-semibold">--</strong>
          </span>
          <span class="flex flex-col items-center">
              <span class="text-xs text-slate-400">SPEED</span>
              <strong id="infoSpeed" class="text-2xl text-white font-semibold">--</strong>
              <span class="text-xs text-slate-400 -mt-1">KPH</span>
          </span>
      </div>
      <div class="mt-1 text-center">
          <span class="text-xs text-slate-400 block mb-1">DRIVER STATUS</span>
          <span id="infoAlerts" class="text-slate-500 font-semibold px-2 py-1 rounded text-base">N/A</span> </div>
  </div>
  <script>
    const WSS_URL = 'wss://project-1-6xbs.onrender.com';

    // === **** (อัปเดต) ให้ใช้ iceServers ชุดเดียวกับ Final_2.html **** ===
    const iceServers = [
      { urls: 'stun:stun.l.google.com:19302' },
      { urls: 'stun:stun1.l.google.com:19302' },
      { urls: "stun:global.stun.twilio.com:3478" },
      { 
        urls: "turn:numb.viagenie.ca:3478",
        username: "webrtc@live.com",
        credential: "muazkh" 
      },
      { 
        urls: 'turn:openrelay.metered.ca:80', 
        username: 'openrelayproject', 
        credential: 'openrelayproject' 
      },
      { 
        urls: 'turn:openrelay.metered.ca:443', 
        username: 'openrelayproject', 
        credential: 'openrelayproject' 
      }
    ];
    // === **** (จบส่วนอัปเดต) **** ===


    // Element ต่างๆ
    const videoEl = document.getElementById('driverVideo');
    const muteButton = document.getElementById('muteButton');
    const iconSpeaker = document.getElementById('iconSpeaker');
    const iconMuted = document.getElementById('iconMuted');
    const statusIndicator = document.getElementById('statusIndicator');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const driverInfoEl = document.getElementById('driverInfo');
    const infoScoreEl = document.getElementById('infoScore');
    const infoSpeedEl = document.getElementById('infoSpeed');
    const infoAlertsEl = document.getElementById('infoAlerts');

    let pc; // PeerConnection
    let ws; // WebSocket
    let isMuted = false;

    function updateStatus(connected, message = '') {
      if (connected) {
        statusDot.classList.remove('bg-red-500', 'animate-pulse');
        statusDot.classList.add('bg-green-500');
        statusText.textContent = message || 'Connected';
      } else {
        statusDot.classList.remove('bg-green-500');
        statusDot.classList.add('bg-red-500', 'animate-pulse');
        statusText.textContent = message || 'Disconnected';
        videoEl.srcObject = null; 
        driverInfoEl.classList.add('hidden');
      }
    }

    function toggleMute() {
      isMuted = !isMuted;
      videoEl.muted = isMuted;
      iconSpeaker.classList.toggle('hidden', isMuted);
      iconMuted.classList.toggle('hidden', !isMuted);
      muteButton.setAttribute('title', isMuted ? 'Unmute' : 'Mute');
    }
    
    videoEl.muted = isMuted;
    iconSpeaker.classList.toggle('hidden', isMuted);
    iconMuted.classList.toggle('hidden', !isMuted);
    muteButton.setAttribute('title', isMuted ? 'Unmute' : 'Mute');
    muteButton.addEventListener('click', toggleMute);

    function createPeerConnection() {
      pc = new RTCPeerConnection({ iceServers: iceServers });

      pc.onicecandidate = (event) => {
        if (event.candidate && ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'candidate', payload: event.candidate }));
        }
      };

      pc.ontrack = (event) => {
        console.log('Got remote track!');
        // (แก้ไข) เพื่อความชัวร์ ให้เช็ก track ว่ามีไหม
        if (event.streams && event.streams[0]) {
            videoEl.srcObject = event.streams[0];
            driverInfoEl.classList.remove('hidden');
        } else {
             console.error('onTrack event fired but no stream found.');
        }
      };

      pc.onconnectionstatechange = (event) => {
          const state = pc.connectionState;
          console.log('PeerConnection State:', state);
          if (state === 'connected') {
              updateStatus(true, 'Stream Connected');
              driverInfoEl.classList.remove('hidden'); 
          } else if (state === 'failed' || state === 'disconnected' || state === 'closed') {
              updateStatus(false, 'Stream Disconnected');
              if(pc) pc.close();
              pc = null;
              infoScoreEl.textContent = '--';
              infoSpeedEl.textContent = '--';
              infoAlertsEl.textContent = 'N/A';
              infoAlertsEl.className = 'text-slate-500 font-semibold px-2 py-1 rounded text-base';
              driverInfoEl.classList.add('hidden');
          } else {
              updateStatus(true, `Stream ${state}...`);
              driverInfoEl.classList.add('hidden');
          }
      };
    }

    function connectWebSocket() {
      updateStatus(false, 'Connecting to server...');
      driverInfoEl.classList.add('hidden');
      ws = new WebSocket(WSS_URL);

      ws.onopen = () => {
        console.log('Connected to Signaling Server as Monitor');
        ws.send(JSON.stringify({ type: 'identify', role: 'monitor' }));
        updateStatus(true, 'Server Connected'); 
        
        // (แก้ไข) เราสร้าง PC ไว้รอรับ Offer ได้เลย
        // ไม่ต้องรอ onmessage
        if (!pc) {
            createPeerConnection();
        }
      };

      ws.onmessage = async (message) => {
        const data = JSON.parse(message.data);
        
        if (data.type === 'info') {
           console.log('Server Info:', data.message);
        } else {
           switch (data.type) {
              case 'offer':
                if (!pc) createPeerConnection();
                
                // (แก้ไข) เพิ่มการตั้งค่า Transceiver ให้รับอย่างเดียว
                // เพื่อให้แมตช์กับ Final_2 (ที่ส่งอย่างเดียว)
                pc.getTransceivers().forEach(transceiver => {
                    if (transceiver.direction === 'inactive') {
                       transceiver.direction = 'recvonly';
                    }
                });
                
                await pc.setRemoteDescription(new RTCSessionDescription(data.payload));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                ws.send(JSON.stringify({ type: 'answer', payload: answer }));
                break;
              case 'candidate':
                if (pc && data.payload) {
                  try { await pc.addIceCandidate(new RTCIceCandidate(data.payload)); }
                  catch (e) { console.error('Error adding ICE candidate', e); }
                }
                break;

              case 'statusUpdate':
                const payload = data.payload;
                infoScoreEl.textContent = payload.score ?? '--';
                infoSpeedEl.textContent = payload.speed ?? '--';
                const alerts = payload.alerts;
                let alertText = 'NORMAL';
                const activeAlerts = [];
                if (alerts.takeBreak) activeAlerts.push('พักผ่อนด่วน!');
                if (alerts.eyeAlert) activeAlerts.push('หลับตา');
                if (alerts.handsAlert) activeAlerts.push('ปล่อยมือสองข้าง');
                if (alerts.wheelAlert) activeAlerts.push('ละมือจากพวงมาลัย');
                if (alerts.phoneAlert) activeAlerts.push('ใช้โทรศัพท์');
                if (alerts.pitchText === 'ก้มหน้า') activeAlerts.push('ก้มหน้า');
                if (alerts.pitchText === 'เงยหน้า') activeAlerts.push('เงยหน้า');
                if (alerts.yawnAlert) activeAlerts.push('หาว');
                if (alerts.faceLost) activeAlerts.push('ไม่พบใบหน้า');
                if (alerts.yawText === 'หันซ้าย') activeAlerts.push('หันซ้าย');
                if (alerts.yawText === 'หันขวา') activeAlerts.push('หันขวา');

                if (activeAlerts.length > 0) {
                    alertText = activeAlerts.join(' / ');
                    infoAlertsEl.textContent = alertText;
                    infoAlertsEl.className = 'text-red-400 font-semibold px-2 py-1 rounded bg-red-900/50 text-base animate-pulse';
                } else {
                    infoAlertsEl.textContent = alertText;
                    infoAlertsEl.className = 'text-green-400 font-semibold px-2 py-1 rounded bg-green-900/50 text-base';
                }
                break;
            }
        } 
      }; 

      ws.onclose = () => {
        console.log('Disconnected from server. Retrying...');
        updateStatus(false, 'Server Disconnected. Retrying...');
        if(pc) {
          pc.close();
          pc = null;
        }
        infoScoreEl.textContent = '--';
        infoSpeedEl.textContent = '--';
        infoAlertsEl.textContent = 'N/A';
        infoAlertsEl.className = 'text-slate-500 font-semibold px-2 py-1 rounded text-base';
        driverInfoEl.classList.add('hidden'); 

        setTimeout(connectWebSocket, 3000);
      };

      ws.onerror = (err) => {
        console.error('WebSocket Error:', err);
        updateStatus(false, 'Server Connection Error');
        driverInfoEl.classList.add('hidden');
      };
    }

    connectWebSocket();
  </script>
</body>
</html>