<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Real-time Driver Monitoring System</title>
  <link rel="icon" href="data:,">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@latest/dist/coco-ssd.min.js"></script>
  <style>
    :root { --safe-inset-bottom: env(safe-area-inset-bottom); }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    .video-wrap { position: relative; width: 100%; max-width: 560px; aspect-ratio: 3/4; }
    @media (max-width: 768px){ .video-wrap{ max-width:100%; aspect-ratio: unset; height: calc(100dvh - 120px); } }
    #video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
    #overlay { position: absolute; inset: 0; transform: scaleX(-1); }
    .action-bar { position: fixed; inset: auto 1rem 1rem 1rem; padding-bottom: calc(var(--safe-inset-bottom) + 0.5rem); z-index: 60; }
    .status-badge { display: flex; align-items: center; justify-content: center; width: 2rem; height: 2rem; border-radius: 999px; }
    .indicator-group { position: fixed; top: 1rem; right: 1rem; z-index: 50; display: flex; gap: 0.5rem; padding: 0.5rem; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(8px); border-radius: 0.5rem; }
    .indicator-group svg { color: white; }
    .indicator-count-group {
      position: fixed;
      top: 5rem;
      right: 1rem;
      z-index: 50;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      padding: 0.5rem;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(8px);
      border-radius: 0.5rem;
      color: white;
      font-size: 0.75rem;
    }
    .indicator-count-item {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      font-weight: 600;
    }
    .alert-popup { position: fixed; inset: 0; z-index: 50; display: none; align-items: center; justify-content: center; padding: 1rem; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); }
    .alert-popup.show { display: flex; }
    .alert-popup .card { padding: 1.5rem; border-radius: 1.5rem; text-align: center; box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
    .alert-popup .card.success { background-color: #10b981; }
    .alert-popup .card.error { background-color: #dc2626; }
    .alert-popup .card.warning { background-color: #f59e0b; }
    .alert-popup .card h2 { font-size: 1.5rem; font-weight: bold; color: white; margin-bottom: 0.5rem; }
    .alert-popup .card p { color: rgba(255, 255, 255, 0.8); }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  </style>
  <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js" defer></script>
</head>
<body class="bg-slate-900 min-h-screen text-white">
  <main class="mx-auto max-w-5xl p-4">
    <header class="mb-3 text-center">
      <h1 class="text-2xl font-bold">Real-time Driver Monitoring System</h1>
      <p class="text-slate-400 text-sm">ตรวจจับการขับขี่ในแบบเรียลไทม์</p>
    </header>

    <section class="video-wrap mx-auto rounded-xl overflow-hidden bg-gray-800">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="overlay"></canvas>
    </section>

    <div class="indicator-group">
      <div id="eyesStatus" class="status-badge bg-green-500">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-white"><path d="M12 15a3 3 0 100-6 3 3 0 000 6z" /><path fill-rule="evenodd" d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.223-10.675-7.69a1.125 1.125 0 010-1.113zM12 17.25a5.25 5.25 0 100-10.5 5.25 5.25 0 000 10.5z" clip-rule="evenodd" /></svg>
      </div>
      <div id="phoneStatus" class="status-badge bg-green-500">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-white"><path fill-rule="evenodd" d="M1.5 4.5a3 3 0 013-3h15a3 3 0 013 3v13.5a3 3 0 01-3 3h-15a3 3 0 01-3-3V4.5zM15 15.75a.75.75 0 00.75.75h2.25a.75.75 0 00.75-.75V8.25a.75.75 0 00-.75-.75H15a.75.75 0 00-.75.75v7.5z" clip-rule="evenodd" /></svg>
      </div>
      <div id="handsStatus" class="status-badge bg-green-500">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-white"><path fill-rule="evenodd" d="M11.484 2.17a.75.75 0 01.022 1.063L5.55 11.25a3 3 0 00-1.757 2.252l-.64 3.425a.75.75 0 01-1.096.38l-1.11-1.11a.75.75 0 01.38-1.096l3.425-.641a3 3 0 002.252-1.757l8.02-8.02A.75.75 0 0121.83 2.5l-2.75 2.75a.75.75 0 01-1.06-.022zM21 12a.75.75 0 01-.75.75h-3.5a.75.75 0 010-1.5h3.5A.75.75 0 0121 12zM15 18a.75.75 0 01-.75.75H12a.75.75 0 010-1.5h2.25A.75.75 0 0115 18zM18 15a.75.75 0 01-.75.75H15a.75.75 0 010-1.5h2.25A.75.75 0 0118 15zM6.75 19.5a.75.75 0 01.75-.75h2.25a.75.75 0 010 1.5H7.5a.75.75 0 01-.75-.75z" clip-rule="evenodd" /><path d="M16.5 7.5a.75.75 0 01.75-.75h.75a.75.75 0 010 1.5h-.75A.75.75 0 0116.5 7.5z" /></svg>
      </div>
      <div id="wheelStatus" class="status-badge bg-green-500">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-white"><path fill-rule="evenodd" d="M2.55 7.525a8.25 8.25 0 0110.152-4.144L12 4.582a6.75 6.75 0 00-8.237 3.328l-1.213-.385zM12 18a6 6 0 100-12 6 6 0 000 12zM11.25 9a.75.75 0 00-1.5 0v3.257a3 3 0 00-.776-.804l-1.724-1.725a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.06 0l2.25-2.25a.75.75 0 00-1.06-1.06l-1.725 1.724a3 3 0 00-.804.776V9z" clip-rule="evenodd" /><path d="M19.423 9.424a.75.75 0 00-.735-1.06l-2.434.646a.75.75 0 00-.372 1.455l2.062-.549.278.847a.75.75 0 001.442-.473L19.5 9.75l.138-.415.286.076a.75.75 0 00.347-1.458l-2.06-.549-.12.364a.75.75 0 00.223.882zM15.908 4.296a.75.75 0 00-.53-1.285l-1.21-.384a.75.75 0 00-.38.38l-.05.151.05.15a.75.75 0 00.38.38l1.21.385a.75.75 0 00.53-.38l.05-.15-.05-.15zM21.75 12a.75.75 0 00-.75-.75H19a.75.75 0 000 1.5h2A.75.75 0 0021.75 12zM17.25 20a.75.75 0 000 1.5h2a.75.75 0 000-1.5h-2zM12.75 22.5a.75.75 0 000 1.5h.75a.75.75 0 000-1.5h-.75z" /></svg>
      </div>
    </div>

    <div class="indicator-count-group">
      <div class="indicator-count-item">
        <span>Blinks:</span>
        <span id="blinkCount">0</span>
      </div>
      <div class="indicator-count-item">
        <span>Eyes:</span>
        <span id="eyesCount">0</span>
      </div>
      <div class="indicator-count-item">
        <span>Yawn:</span>
        <span id="yawnCount">0</span>
      </div>
      <div class="indicator-count-item">
        <span>Phone:</span>
        <span id="phoneCount">0</span>
      </div>
      <div class="indicator-count-item">
        <span>Hands:</span>
        <span id="handsCount">0</span>
      </div>
      <div class="indicator-count-item">
        <span>Wheel:</span>
        <span id="wheelCount">0</span>
      </div>
      <div class="indicator-count-item">
        <span>Look:</span>
        <span id="lookCount">0</span>
      </div>
      
      <div class="indicator-count-item" id="poseDisplay" style="display: none; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 0.25rem; margin-top: 0.25rem;">
        <span>Pitch:</span>
        <span id="pitchValue">0.0</span>
      </div>
      <div class="indicator-count-item" id="yawDisplay" style="display: none;">
        <span>Yaw:</span>
        <span id="yawValue">0.0</span>
      </div>
      </div>

    <div id="alertBox" class="alert-popup">
      <div id="alertCard" class="card">
        <h2 id="alertText" class="text-2xl"></h2>
        <p id="alertSubText" class="text-white mt-1"></p>
        <p class="text-slate-200 text-sm mt-4">กรุณาขับขี่ปลอดภัยด้วยนะครับ</p>
      </div>
    </div>

    <section class="action-bar flex gap-2">
      <button id="btnCalib" class="px-4 py-2 rounded-xl text-white bg-indigo-600 hover:bg-indigo-700 font-semibold shadow flex-1 disabled:bg-indigo-400">Calibrate</button>
      <button id="btnToggle" class="px-4 py-2 rounded-xl text-white bg-blue-600 hover:bg-blue-700 font-semibold shadow flex-1 disabled:bg-blue-400" disabled>Start</button>
      <button id="btnTogglePose" class="px-4 py-2 rounded-xl text-white bg-gray-600 hover:bg-gray-700 font-semibold shadow flex-1">Show Pose</button>
    </section>
    </main>

  <audio id="sndEyes"  src="./static/Sound/sndEyes.mp3" preload="auto"></audio>
  <audio id="sndYawn"  src="./static/Sound/sndYawn.mp3" preload="auto"></audio>
  <audio id="sndPhone" src="./static/Sound/sndPhone.mp3" preload="auto"></audio>
  <audio id="sndWheel" src="./static/Sound/sndWheel.mp3" preload="auto"></audio>
  <audio id="sndLook"  src="./static/Sound/sndLook.mp3" preload="auto"></audio>

  <script type="module">
    import { FaceLandmarker, HandLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14";

    // === Elements
    const video = document.getElementById('video');
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');

    const btnToggle = document.getElementById('btnToggle');
    const btnCalib = document.getElementById('btnCalib');
    const alertBox = document.getElementById('alertBox');
    const alertCard = document.getElementById('alertCard');
    
    const eyesStatusIcon = document.getElementById('eyesStatus');
    const phoneStatusIcon = document.getElementById('phoneStatus');
    const handsStatusIcon = document.getElementById('handsStatus');
    const wheelStatusIcon = document.getElementById('wheelStatus');
    
    const sndEyes  = document.getElementById('sndEyes');
    const sndYawn  = document.getElementById('sndYawn');
    const sndPhone = document.getElementById('sndPhone');
    const sndWheel = document.getElementById('sndWheel');
    const sndLook  = document.getElementById('sndLook');
    
    const blinkCountDisplay = document.getElementById('blinkCount');
    const eyesCountDisplay = document.getElementById('eyesCount');
    const yawnCountDisplay = document.getElementById('yawnCount');
    const phoneCountDisplay = document.getElementById('phoneCount');
    const handsCountDisplay = document.getElementById('handsCount');
    const wheelCountDisplay = document.getElementById('wheelCount');
    const lookCountDisplay = document.getElementById('lookCount'); 

    const btnTogglePose = document.getElementById('btnTogglePose');
    const poseDisplay = document.getElementById('poseDisplay');
    const yawDisplay = document.getElementById('yawDisplay');
    const pitchValue = document.getElementById('pitchValue');
    const yawValue = document.getElementById('yawValue');

    // === Config ===
    const THRESH = {
      EYE_CLOSED: 0.10, // <-- (แก้ไข) ปรับค่าสำหรับตาตี่ (ลองเริ่มที่ 0.10)
      YAWN: 0.25,
      EYE_CLOSED_SEC: 0.8,
      YAWN_SEC: 1.5,
      BOTH_HANDS_UP_SEC: 2,
      PITCH_DOWN: 5,     
      PITCH_UP: -15,   
      YAW_LEFT: 10,    
      YAW_RIGHT: -12,  
      PHONE_SCORE: 0.55,
      WHEEL_OFF_ALERT_SEC: 3.0,
      FACE_LOST_ALERT_SEC: 2.0,
      PHONE_HAND_DISTANCE: 0.3,
      PHONE_LOST_GRACE_SEC: 1.5,
      // HAND_FACE_DISTANCE: 0.4, // <-- (ลบออก) ไม่ใช้เงื่อนไขนี้แล้ว
      YAW_ALERT_SEC: 1.5,     
      PITCH_DOWN_SEC: 1.5   
    };
    
    // === State
    let isRunning = false, isBusy = false, lastTick = 0;
    let calibrated = false;
    let wheelOffStart = null;
    let showPose = false; 

    let faceLandmarker, handLandmarker, cocoSsdModel = null;
    let modelsReady = false, phoneReady = false;

    let pitchOffset=0, yawOffset=0;
    let pitchEMA=null, yawEMA=null, rollEMA=null;
    let eyeStart=null, yawnStart=null, handsStart=null, lastPhoneDetections = [];
    
    let yawLeftStart = null, yawRightStart = null, pitchDownStart = null;
    let hasAlertedYawLeft = false, hasAlertedYawRight = false, hasAlertedPitchDown = false;
    
    let faceLastSeen = null;

    let frameCount = 0;
    const poseGain = 1.2, yawGain = 2.0, pitchGain = 1.4;
    
    let blinkCount = 0, eyesCount = 0, yawnCount = 0, phoneCount = 0, handsCount = 0, wheelCount = 0, lookCount = 0; 
    
    let isEyeClosed = false;
    let hasAlertedEyes = false, hasAlertedYawn = false, hasAlertedPhone = false, hasAlertedHands = false, hasAlertedWheel = false;
    let phoneLastSeenTime = null;

    let currentAudioAlert = null; 
    let fadeOutIntervals = {}; 

    // === Utils
    const ema = (p,v,a=0.35)=>(!Number.isFinite(v)?p:(p==null?v:a*v+(1-a)*p));
    const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));
    const rad2deg=(r)=>r*57.2957795;
    const getDistance = (p1, p2) => Math.hypot(p1.x - p2.x, p1.y - p2.y);

    // === ฟังก์ชันจัดการเสียง (Fade Out & Priority) ===
    function playAlertSound(id, el) {
      if (fadeOutIntervals[id]) {
        clearInterval(fadeOutIntervals[id]);
        delete fadeOutIntervals[id];
      }
      if (currentAudioAlert !== id) {
        stopAllSoundsNow(id); 
      }
      el.loop = true;
      el.volume = 1.0; 
      el.play().catch(()=>{});
      currentAudioAlert = id; 
    }

    function stopAlertSound(id, el) {
      if (!el || el.paused) return; 
      if (fadeOutIntervals[id]) return; 

      el.loop = false; 

      fadeOutIntervals[id] = setInterval(() => {
        let newVolume = el.volume - 0.1; 
        if (newVolume <= 0) {
          clearInterval(fadeOutIntervals[id]); 
          delete fadeOutIntervals[id]; 
          el.pause();
          el.currentTime = 0;
          el.volume = 1.0; 
          if (currentAudioAlert === id) {
            currentAudioAlert = null; 
          }
        } else {
          el.volume = newVolume;
        }
      }, 80); 
    }

    function stopAllSoundsNow(exceptId = null) {
      const allSounds = {
        'EYES': sndEyes,
        'YAWN': sndYawn,
        'PHONE': sndPhone,
        'WHEEL': sndWheel,
        'LOOK': sndLook
      };
      for (const id in allSounds) {
        if (id !== exceptId) {
          const el = allSounds[id];
          if (fadeOutIntervals[id]) {
            clearInterval(fadeOutIntervals[id]);
            delete fadeOutIntervals[id];
          }
          el.pause();
          el.currentTime = 0;
          el.volume = 1.0; 
          el.loop = false;
        }
      }
      if (currentAudioAlert && currentAudioAlert !== exceptId) {
        currentAudioAlert = null;
      }
    }
    
    // ===================================================
    
    const EYE_L = [33,160,158,133,153,144];
    const EYE_R = [263,387,385,362,380,373];
    const MOUTH_TOP = 13, MOUTH_BOTTOM = 14, MOUTH_LEFT = 61, MOUTH_RIGHT = 291;

    const dist=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y);
    const ear=(lm,i)=>(dist(lm[i[1]],lm[i[5]])+dist(lm[i[2]],lm[i[4]]))/(2*dist(lm[i[0]],lm[i[3]]));
    const marSimple=(lm)=>dist(lm[MOUTH_TOP], lm[MOUTH_BOTTOM]) / (dist(lm[MOUTH_LEFT], lm[MOUTH_RIGHT])+1e-6);

    function eulerFromR(r){ const r00=r[0],r01=r[1],r02=r[2]; const r10=r[3],r11=r[4],r12=r[5]; const r20=r[6],r21=r[7],r22=r[8]; const sy=Math.hypot(r00,r10); let pitch,yaw,roll; if(sy>1e-6){ pitch=Math.atan2(-r20,sy); yaw=Math.atan2(r10,r00); roll=Math.atan2(r21,r22);} else { pitch=Math.atan2(-r20,sy); yaw=Math.atan2(-r01,r11); roll=0;} return {pitch:rad2deg(pitch),yaw:rad2deg(yaw),roll:rad2deg(roll)}; }
    function poseFromMatrixAuto(m4){ if(!m4) return null; const a=Array.from(m4); if(a.length<16) return null; const Rr=[a[0],a[1],a[2], a[4],a[5],a[6], a[8],a[9],a[10]]; const Rc=[a[0],a[4],a[8], a[1],a[5],a[9], a[2],a[6],a[10]]; const er=eulerFromR(Rr), ec=eulerFromR(Rc); const mr=Math.abs(er.pitch)+Math.abs(er.yaw)+Math.abs(er.roll); const mc=Math.abs(ec.pitch)+Math.abs(ec.yaw)+Math.abs(ec.roll); const useCol=mc>mr*1.1; const e=useCol?ec:er; return { pitch:clamp(e.pitch,-60,60), yaw:clamp(e.yaw,-90,90), roll:clamp(e.roll,-60,60) }; }
    function poseSimple(lm){ const Leye=lm[33],Reye=lm[263],Nose=lm[1]; if(!Leye||!Reye||!Nose) return null; const midX=(Leye.x+Reye.x)/2, midY=(Leye.y+Reye.y)/2; const yaw=(Nose.x-midX)*260; const pitch=(midY-Nose.y)*360; return {pitch:clamp(pitch,-60,66),yaw:clamp(yaw,-90,90),roll:0}; }
    function resizeCanvas(){ const w=video.videoWidth||640, h=video.videoHeight||480; canvas.width=w; canvas.height=h; }
    window.addEventListener('resize',()=>{ if(video?.videoWidth) resizeCanvas(); });
    
    function collectHands(resH){
      const out=[];
      const lms = resH?.landmarks||[];
      const hd  = resH?.handednesses||[];
      for(let i=0;i<lms.length;i++){
        const lm = lms[i];
        const handed = hd?.[i]?.[0]?.categoryName || null;
        out.push({ lm, handedness: handed });
      }
      return out;
    }

    async function initModels(){
      if(modelsReady) return;
      const resolver = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm");
      faceLandmarker = await FaceLandmarker.createFromOptions(resolver,{
        baseOptions:{ modelAssetPath:"https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/latest/face_landmarker.task" },
        numFaces: 2,
        runningMode:"VIDEO", outputFaceBlendshapes:false, outputFacialTransformationMatrixes:true
      });
      handLandmarker = await HandLandmarker.createFromOptions(resolver,{
        baseOptions:{ modelAssetPath:"https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/latest/hand_landmarker.task" },
        numHands:2, runningMode:"VIDEO"
      });
      
      cocoSsdModel = await cocoSsd.load();
      console.log('COCO-SSD model loaded.');

      modelsReady=true; phoneReady=true;
    }

    async function startCam(){
      try{
        const st = await navigator.mediaDevices.getUserMedia({
          video:{ facingMode:"user", width:{ideal:1280}, height:{ideal:720}, frameRate:{ideal:30,max:30}},
          audio:false
        });
        video.srcObject=st;
        await new Promise(r=>{ if(video.readyState>=1) r(); else video.onloadedmetadata=()=>r();});
        await video.play();
        resizeCanvas();
      }catch(err){
        console.error(err);
        alertText.textContent = "ไม่สามารถเปิดกล้องได้";
        alertCard.classList.remove('success');
        alertCard.classList.add('error');
        alertBox.classList.add('show');
        btnCalib.disabled = false;
        throw err;
      }
    }

    function updateStatusIcons(v){
      const alertTextEl = document.getElementById('alertText');
      const alertSubTextEl = document.getElementById('alertSubText');

      const alertMessages = {
        eyeAlert:   { main: 'ตรวจพบการหลับตา', sub: 'กรุณาลืมตาขณะขับขี่ หากไม่ไหวให้จอดพัก' },
        handsAlert: { main: 'ปล่อยมือทั้งสองข้าง', sub: 'อันตราย! กรุณาควบคุมรถ' },
        wheelAlert: { main: 'ละมือจากพวงมาลัย', sub: 'กรุณาจับพวงมาลัยให้มั่นคง' },
        phoneAlert: { main: 'ใช้โทรศัพท์', sub: 'โปรดวางโทรศัพท์และตั้งใจขับรถ' },
        yawnAlert:  { main: 'ตรวจพบการหาว', sub: 'ความง่วงเป็นสาเหตุของอุบัติเหตุ จอดพักสักครู่' },
        pitchDown:  { main: 'ก้มหน้า', sub: 'โปรดมองตรงไปข้างหน้า' },
        pitchUp:    { main: 'เงยหน้า', sub: 'โปรดมองถนนเพื่อความปลอดภัย' },
        faceLost:   { main: 'ไม่พบใบหน้า', sub: 'กรุณาปรับตำแหน่งกล้องให้อยู่ในมุมที่เหมาะสม' },
        yawLeft:    { main: 'หันซ้าย', sub: 'โปรดให้ความสนใจกับเส้นทางด้านหน้า' },
        yawRight:   { main: 'หันขวา', sub: 'โปรดให้ความสนใจกับเส้นทางด้านหน้า' },
      };

      const alertPriority = [
        'eyeAlert', 'handsAlert', 'wheelAlert', 'phoneAlert', 'pitchDown', 'pitchUp', 
        'yawnAlert', 'faceLost', 'yawLeft', 'yawRight'
      ];
      
      const mainAlerts = [];
      let subText = '';
      let alertLevel = 'none';

      if (v.yawAlertText) {
        const key = v.yawAlertText === 'หันซ้าย' ? 'yawLeft' : 'yawRight';
        mainAlerts.push(alertMessages[key].main);
        if (alertLevel === 'none' || alertLevel === 'success') alertLevel = 'warning';
      }

      if (v.pitchAlertText) {
        const key = v.pitchAlertText === 'ก้มหน้า' ? 'pitchDown' : 'pitchUp';
        mainAlerts.push(alertMessages[key].main);
        alertLevel = 'error';
      }

      if (v.eyeAlert)   { mainAlerts.push(alertMessages.eyeAlert.main);   alertLevel = 'error'; }
      if (v.handsAlert) { mainAlerts.push(alertMessages.handsAlert.main); alertLevel = 'error'; }
      if (v.wheelAlert) { mainAlerts.push(alertMessages.wheelAlert.main); alertLevel = 'error'; }
      if (v.phoneAlert) { mainAlerts.push(alertMessages.phoneAlert.main); alertLevel = 'error'; }
      if (v.faceLost)   { mainAlerts.push(alertMessages.faceLost.main);   alertLevel = 'error'; }
      
      if (v.yawnAlert) {
        mainAlerts.push(alertMessages.yawnAlert.main);
        if (yawnCount >= 3) {
            alertLevel = 'error';
        } else if (yawnCount === 2 && alertLevel !== 'error') {
            alertLevel = 'warning';
        } else if (alertLevel === 'none') {
            alertLevel = 'success';
        }
      }

      if (mainAlerts.length > 0) {
        for (const key of alertPriority) {
          if (mainAlerts.includes(alertMessages[key]?.main)) {
            subText = alertMessages[key].sub;
            break;
          }
        }
        alertTextEl.textContent = mainAlerts.join(' / ');
        alertSubTextEl.textContent = subText;
        alertCard.classList.remove('success', 'error', 'warning');
        if (alertLevel !== 'none') {
          alertCard.classList.add(alertLevel);
        }
        alertBox.classList.add('show');
      } else {
        alertBox.classList.remove('show');
      }
      
      const red = '#dc2626', yellow = '#f59e0b', green = '#10b981', defaultColor = '';
      eyesStatusIcon.style.backgroundColor = (v.eyeAlert || (v.pitchAlertText && alertLevel === 'error')) ? red : (v.yawAlertText ? yellow : defaultColor);
      if (v.yawnAlert) {
        if (yawnCount >= 3) { eyesStatusIcon.style.backgroundColor = red; }
        else if (yawnCount === 2) { eyesStatusIcon.style.backgroundColor = yellow; }
        else { eyesStatusIcon.style.backgroundColor = green; }
      }
      phoneStatusIcon.style.backgroundColor = v.phoneAlert ? red : defaultColor;
      handsStatusIcon.style.backgroundColor = v.handsAlert ? red : defaultColor;
      wheelStatusIcon.style.backgroundColor = v.wheelAlert ? red : defaultColor;

      // --- Logic การจัดการเสียง (Priority & Fade Out) ---
      const soundPriority = [
        { flag: v.eyeAlert,       id: 'EYES',  el: sndEyes  },
        { flag: v.phoneAlert,     id: 'PHONE', el: sndPhone }, 
        { flag: v.handsAlert,     id: 'WHEEL', el: sndWheel }, 
        { flag: v.wheelAlert,     id: 'WHEEL', el: sndWheel },
        { flag: v.pitchAlertText, id: 'LOOK',  el: sndLook  }, 
        { flag: v.yawAlertText,   id: 'LOOK',  el: sndLook  },
        { flag: v.yawnAlert,      id: 'YAWN',  el: sndYawn  }
      ];

      let soundToPlay = null;
      for (const item of soundPriority) {
        if (item.flag) { 
          soundToPlay = item;
          break; 
        }
      }

      if (soundToPlay) {
        playAlertSound(soundToPlay.id, soundToPlay.el);
      } else {
        if (currentAudioAlert) {
          const allSounds = {
            'EYES': sndEyes, 'YAWN': sndYawn, 'PHONE': sndPhone, 'WHEEL': sndWheel, 'LOOK': sndLook
          };
          const elToStop = allSounds[currentAudioAlert];
          if (elToStop) {
            stopAlertSound(currentAudioAlert, elToStop);
          }
          currentAudioAlert = null; 
        }
      }
      // --- (จบ Logic การจัดการเสียง) ---

      blinkCountDisplay.textContent = blinkCount;
      eyesCountDisplay.textContent = eyesCount;
      yawnCountDisplay.textContent = yawnCount;
      phoneCountDisplay.textContent = phoneCount;
      handsCountDisplay.textContent = handsCount;
      wheelCountDisplay.textContent = wheelCount;
      lookCountDisplay.textContent = lookCount; 
    }

    const rVFC = video.requestVideoFrameCallback?.bind(video);
    function scheduleNext(loopFn){ if(rVFC) rVFC(()=>loopFn()); else requestAnimationFrame(loopFn); }
    const getFPS=()=>30;

    async function loop(){
      if(!isRunning) return;
      const now=performance.now();
      const budget=1000/getFPS();
      if(now-lastTick<budget){ return scheduleNext(loop);}
      lastTick=now;
      if(isBusy){ return scheduleNext(loop);}
      isBusy=true;

      try{
        const resF = faceLandmarker?.detectForVideo?.(video, now);
        const resH = handLandmarker?.detectForVideo?.(video, now);
        
        let driverFace = null;
        if (resF?.faceLandmarks && resF.faceLandmarks.length > 0) {
          if (resF.faceLandmarks.length === 1) {
            driverFace = resF.faceLandmarks[0];
          } else {
            let largestArea = 0;
            for (const landmarks of resF.faceLandmarks) {
              const left = landmarks[234].x, right = landmarks[454].x, top = landmarks[10].y, bottom = landmarks[152].y;
              const area = Math.abs(right - left) * Math.abs(bottom - top);
              if (area > largestArea) {
                largestArea = area;
                driverFace = landmarks;
              }
            }
          }
        }
        const face = driverFace;

        const hands = collectHands(resH);

        let eyeAlert=false,yawnAlert=false,handsAlert=false,phoneAlert=false,phone=false, wheelAlert=false;
        let faceLost=false, yawAlertText='', pitchAlertText='';

        ctx.clearRect(0,0,canvas.width,canvas.height);

        if(face){
          const m4 = resF?.facialTransformationMatrixes?.[0];
          let pose = poseFromMatrixAuto(m4) || poseSimple(face);
          if(pose){
            pitchEMA=ema(pitchEMA, pose.pitch);
            yawEMA=ema(yawEMA, pose.yaw);
            const calibratedPitch = (pitchEMA - pitchOffset) * poseGain * pitchGain;
            const calibratedYaw = (yawEMA - yawOffset) * poseGain * yawGain;
            const finalPitch = -calibratedPitch;
            const finalYaw = calibratedYaw;

            if (showPose) {
              pitchValue.textContent = finalPitch.toFixed(1);
              yawValue.textContent = finalYaw.toFixed(1);
            }

            // --- YAW (หันซ้าย/ขวา) ---
            if (finalYaw > THRESH.YAW_LEFT) { 
                if (yawLeftStart === null) yawLeftStart = now; 
                yawRightStart = null; hasAlertedYawRight = false; 

                if ((now - yawLeftStart) / 1000 > THRESH.YAW_ALERT_SEC) {
                    yawAlertText = 'หันซ้าย';
                    if (!hasAlertedYawLeft) { lookCount++; hasAlertedYawLeft = true; }
                }
            } else if (finalYaw < THRESH.YAW_RIGHT) { 
                if (yawRightStart === null) yawRightStart = now; 
                yawLeftStart = null; hasAlertedYawLeft = false; 

                if ((now - yawRightStart) / 1000 > THRESH.YAW_ALERT_SEC) {
                    yawAlertText = 'หันขวา';
                    if (!hasAlertedYawRight) { lookCount++; hasAlertedYawRight = true; }
                }
            } else { 
                yawLeftStart = null; hasAlertedYawLeft = false;
                yawRightStart = null; hasAlertedYawRight = false;
            }

            // --- PITCH (ก้ม/เงย) ---
            if (finalPitch > THRESH.PITCH_DOWN) { 
                if (pitchDownStart === null) pitchDownStart = now; 

                if ((now - pitchDownStart) / 1000 > THRESH.PITCH_DOWN_SEC) {
                    pitchAlertText = 'ก้มหน้า';
                    if (!hasAlertedPitchDown) { lookCount++; hasAlertedPitchDown = true; }
                }
            } else if (finalPitch < THRESH.PITCH_UP) { 
                pitchAlertText = 'เงยหน้า'; 
                pitchDownStart = null; hasAlertedPitchDown = false; 
                if (!hasAlertedPitchDown) { lookCount++; hasAlertedPitchDown = true; } 
            } else { 
                pitchDownStart = null; hasAlertedPitchDown = false;
            }

          }
          const EAR = ear(face, EYE_L)*0.5 + ear(face, EYE_R)*0.5;
          const MAR = marSimple(face);
          // (แก้ไข) ใช้ THRESH.EYE_CLOSED ที่ปรับค่าแล้ว
          if (EAR < THRESH.EYE_CLOSED) { 
            isEyeClosed = true;
            if(eyeStart==null) { eyeStart=now; } 
            else if((now-eyeStart)/1000>THRESH.EYE_CLOSED_SEC) {
              eyeAlert=true;
              if (!hasAlertedEyes) { eyesCount++; hasAlertedEyes = true; }
            }
          } else {
            if (isEyeClosed) { blinkCount++; }
            isEyeClosed = false; eyeStart = null; hasAlertedEyes = false;
          }
          if(MAR > THRESH.YAWN){ 
            if(yawnStart==null) { yawnStart=now; }
            else if((now-yawnStart)/1000>THRESH.YAWN_SEC) {
              yawnAlert=true;
              if (!hasAlertedYawn) { yawnCount++; hasAlertedYawn = true; }
            }
          } else { yawnStart=null; hasAlertedYawn = false; }
          faceLastSeen = now/1000;
        } else {
          const t = now/1000;
          if(!faceLastSeen) faceLastSeen = t;
          faceLost = (t - faceLastSeen > THRESH.FACE_LOST_ALERT_SEC);
        }

        const handsOnScreen = resH?.landmarks?.length || 0;
        let bothHandsUp = false;
        if (handsOnScreen >= 2 && face) {
          const noseY = face[1].y;
          const leftHand = hands.find(h => h.handedness === 'Left');
          const rightHand = hands.find(h => h.handedness === 'Right');
          if (leftHand && rightHand && leftHand.lm[9].y < noseY && rightHand.lm[9].y < noseY) {
            bothHandsUp = true;
          }
        }
        if (bothHandsUp) {
          if (handsStart === null) handsStart = now;
          if ((now - handsStart) / 1000 > THRESH.BOTH_HANDS_UP_SEC) {
            handsAlert = true;
            if (!hasAlertedHands) { handsCount++; hasAlertedHands = true; }
          }
        } else {
          handsStart = null; hasAlertedHands = false;
        }

        // --- ตรวจจับโทรศัพท์ ---
        let phoneBoxes = []; 
        if (phoneReady && cocoSsdModel) {
          const predictions = await cocoSsdModel.detect(video);
          for (const p of predictions) {
            if (p.class === 'cell phone' && p.score >= THRESH.PHONE_SCORE) {
              const [x, y, width, height] = p.bbox;
              phoneBoxes.push({
                xMin: x, yMin: y, xMax: x + width, yMax: y + height, score: p.score
              });
            }
          }
        }

        let isPhoneDetectedThisFrame = false;
        // (แก้ไข) ลบเงื่อนไข face ออก เช็คแค่ มือ กับ โทรศัพท์ ก็พอ
        if (phoneBoxes?.length && resH?.landmarks?.length) { 
          // const nosePos = face[1]; // ไม่ใช้แล้ว
          for (const box of phoneBoxes) {
            const phoneCenter = { x: (box.xMin + box.xMax) / 2 / video.videoWidth, y: (box.yMin + box.yMax) / 2 / video.videoHeight };
            for (const handLm of resH.landmarks) {
              const wristPos = handLm[0];
              const distHandPhone = getDistance(phoneCenter, wristPos);
              if (distHandPhone < THRESH.PHONE_HAND_DISTANCE) {
                // (ลบออก) ไม่ต้องเช็คระยะห่างจากหน้า
                // const distHandFace = getDistance(wristPos, nosePos);
                // if (distHandFace < THRESH.HAND_FACE_DISTANCE) { 
                isPhoneDetectedThisFrame = true;
                break; 
                // }
              }
            }
            if (isPhoneDetectedThisFrame) break;
          }
        }
        
        if (isPhoneDetectedThisFrame) {
          phoneLastSeenTime = now;
        }

        if (phoneLastSeenTime !== null && (now - phoneLastSeenTime) / 1000 < THRESH.PHONE_LOST_GRACE_SEC) {
          phone = true;
          if (!hasAlertedPhone) { phoneCount++; hasAlertedPhone = true; }
        } else {
          phone = false;
          hasAlertedPhone = false;
          phoneLastSeenTime = null;
        }
        phoneAlert = phone; 

        // --- ตรวจจับพวงมาลัย ---
        if (!handsAlert && !phoneAlert) { 
          if (handsOnScreen === 0) {
            wheelOffStart = null; 
            hasAlertedWheel = false;
          } else {
            if (wheelOffStart === null) wheelOffStart = now; 
            if ((now - wheelOffStart) / 1000 > THRESH.WHEEL_OFF_ALERT_SEC) {
              wheelAlert = true; 
              if (!hasAlertedWheel) { wheelCount++; hasAlertedWheel = true; }
            }
          }
        } else {
          wheelOffStart = null; 
          hasAlertedWheel = false;
        }
        
        updateStatusIcons({ eyeAlert, yawnAlert, handsAlert, phoneAlert, wheelAlert, faceLost, yawAlertText, pitchAlertText });

      }catch(e){ console.error('loop error',e); }
      finally{ isBusy=false; scheduleNext(loop); }
    }

    btnCalib.addEventListener('click', async ()=>{
      if(!isRunning){ btnCalib.disabled = true; }
      alertBox.classList.remove('show');
      try{
        if(!video.srcObject){ await startCam(); }
        if(!modelsReady){ await initModels(); }
        const deadline = performance.now() + 2000;
        let got = false, lastPose = null;
        while(performance.now() < deadline){
          const now = performance.now();
          const resF = faceLandmarker?.detectForVideo?.(video, now);
          
          let calibFace = null;
          if (resF?.faceLandmarks && resF.faceLandmarks.length > 0) {
            calibFace = resF.faceLandmarks[0];
          }

          if(calibFace){
            const m4 = resF?.facialTransformationMatrixes?.[0];
            const pose = poseFromMatrixAuto(m4) || poseSimple(calibFace);
            if(pose && Number.isFinite(pose.pitch) && Number.isFinite(pose.yaw)){ lastPose = pose; got = true; break; }
          }
          await new Promise(r => requestAnimationFrame(()=>r()));
        }
        if(!got){
          alertText.textContent = 'ไม่พบหน้า • ขยับให้อยู่กลางภาพ/เพิ่มแสง';
          alertCard.classList.remove('success'); alertCard.classList.add('error');
          alertBox.classList.add('show');
          return;
        }
        pitchOffset = lastPose.pitch; yawOffset = lastPose.yaw; calibrated = true; btnToggle.disabled = false;
        canvas.style.outline = '3px solid #10b981'; setTimeout(()=>{ canvas.style.outline = 'none'; }, 520);
        alertText.textContent = 'Calibrated! พร้อมเริ่มใช้งาน';
        alertCard.classList.remove('error'); alertCard.classList.add('success');
        alertBox.classList.add('show');
        setTimeout(()=>alertBox.classList.remove('show'), 2200);
      } finally { btnCalib.disabled = false; }
    });

    btnToggle.addEventListener('click', async ()=>{
      if(!isRunning){
        [sndEyes,sndYawn,sndPhone,sndWheel,sndLook].forEach(a=>{ a.play().then(()=>{a.pause();a.currentTime=0;}).catch(()=>{}); });
        try{
          if(!video.srcObject) await startCam();
          if(!modelsReady) await initModels();
          if(!calibrated){ 
            alertText.textContent = 'กด Calibrate ก่อนเริ่ม';
            alertCard.classList.remove('success'); alertCard.classList.add('error');
            alertBox.classList.add('show');
            setTimeout(()=>alertBox.classList.remove('show'), 2200);
            return;
          }
          isRunning = true; btnToggle.textContent='Stop';
          blinkCount = 0; eyesCount = 0; yawnCount = 0; phoneCount = 0; handsCount = 0; wheelCount = 0; lookCount = 0;
          hasAlertedEyes = false; hasAlertedYawn = false; hasAlertedPhone = false; hasAlertedHands = false; hasAlertedWheel = false;
          hasAlertedYawLeft = false; hasAlertedYawRight = false; hasAlertedPitchDown = false;
          scheduleNext(loop);
        }catch(err){ 
          console.error(err);
          alertText.textContent = 'เริ่มไม่สำเร็จ: อนุญาตกล้อง/อินเทอร์เน็ต';
          alertCard.classList.remove('success');
          alertCard.classList.add('error');
          alertBox.classList.add('show');
          btnCalib.disabled = false;
        }
      } else {
        isRunning = false; btnToggle.textContent='Start';
        if (showPose) {
          pitchValue.textContent = '0.0';
          yawValue.textContent = '0.0';
        }
        stopAllSoundsNow(); 
        const s = video.srcObject; if(s){ s.getTracks().forEach(t=>t.stop()); video.srcObject=null; }
        ctx.clearRect(0,0,canvas.width,canvas.height);
        alertText.textContent = 'หยุดการตรวจจับ';
        alertCard.classList.remove('success');
        alertCard.classList.add('error');
        alertBox.classList.add('show');
        setTimeout(()=>alertBox.classList.remove('show'), 2200);
      }
    });

    btnTogglePose.addEventListener('click', () => {
      showPose = !showPose; 
      if (showPose) {
        poseDisplay.style.display = 'flex';
        yawDisplay.style.display = 'flex';
        btnTogglePose.textContent = 'Hide Pose';
        btnTogglePose.classList.remove('bg-gray-600', 'hover:bg-gray-700');
        btnTogglePose.classList.add('bg-green-600', 'hover:bg-green-700');
      } else {
        poseDisplay.style.display = 'none';
        yawDisplay.style.display = 'none';
        btnTogglePose.textContent = 'Show Pose';
        btnTogglePose.classList.remove('bg-green-600', 'hover:bg-green-700');
        btnTogglePose.classList.add('bg-gray-600', 'hover:bg-gray-700');
      }
    });

    (async ()=>{
      try{
        await startCam();
        await initModels();
      }catch{}
    })();
  </script>
</body>
</html>